#!/bin/bash
#
# LokiCMS Management Script
# Usage: ./lokicms [command]
#

set -e
cd "$(dirname "$0")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}"
    echo "╔═══════════════════════════════════════╗"
    echo "║           LokiCMS Manager             ║"
    echo "╚═══════════════════════════════════════╝"
    echo -e "${NC}"
}

case "$1" in
    start)
        echo -e "${GREEN}Starting LokiCMS...${NC}"
        pm2 start ecosystem.config.cjs --only lokicms-api
        pm2 save
        ;;

    stop)
        echo -e "${YELLOW}Stopping LokiCMS...${NC}"
        pm2 stop lokicms-api
        ;;

    restart)
        echo -e "${YELLOW}Restarting LokiCMS...${NC}"
        pm2 restart lokicms-api
        ;;

    status)
        print_header
        pm2 status
        echo ""
        echo -e "${BLUE}Health Check:${NC}"
        curl -s http://localhost:3005/health | python3 -m json.tool 2>/dev/null || echo -e "${RED}Server not responding${NC}"
        ;;

    logs)
        pm2 logs lokicms-api --lines ${2:-50}
        ;;

    monit)
        pm2 monit
        ;;

    build)
        echo -e "${BLUE}Building LokiCMS...${NC}"
        npm run build
        echo -e "${GREEN}Build complete!${NC}"
        ;;

    dev)
        echo -e "${BLUE}Starting development server...${NC}"
        npm run dev
        ;;

    update)
        echo -e "${BLUE}Updating LokiCMS...${NC}"
        git pull
        npm install
        npm run build
        pm2 restart lokicms-api
        echo -e "${GREEN}Update complete!${NC}"
        ;;

    backup)
        BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).tar.gz"
        echo -e "${BLUE}Creating backup: $BACKUP_FILE${NC}"
        tar -czf "$BACKUP_FILE" data/ plugins.json .env 2>/dev/null || true
        echo -e "${GREEN}Backup created: $BACKUP_FILE${NC}"
        ;;

    *)
        print_header
        echo "Usage: ./lokicms [command]"
        echo ""
        echo "Commands:"
        echo -e "  ${GREEN}start${NC}     Start LokiCMS server"
        echo -e "  ${GREEN}stop${NC}      Stop LokiCMS server"
        echo -e "  ${GREEN}restart${NC}   Restart LokiCMS server"
        echo -e "  ${GREEN}status${NC}    Show server status and health"
        echo -e "  ${GREEN}logs${NC}      Show server logs (logs 100 for last 100 lines)"
        echo -e "  ${GREEN}monit${NC}     Open PM2 monitoring dashboard"
        echo -e "  ${GREEN}build${NC}     Build for production"
        echo -e "  ${GREEN}dev${NC}       Start development server"
        echo -e "  ${GREEN}update${NC}    Pull, build, and restart"
        echo -e "  ${GREEN}backup${NC}    Create backup of data and config"
        echo ""
        ;;
esac
